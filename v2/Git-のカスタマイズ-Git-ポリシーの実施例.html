<!DOCTYPE html>
<html lang="ja">

<meta http-equiv="content-type" content="text/html;charset=utf-8" />
<head>

  <meta charset='utf-8'>
  



  <title>Git - Git ポリシーの実施例</title>

 
  

  <link rel="stylesheet" media="screen" href="../../../assets/git-scm-51dae02d97f150a7e22b24f0c7497beb.css" />
  

  <!--[if (gte IE 6)&(lte IE 8)]>
  
  <![endif]-->



</head>

<body id="documentation">

  <div class="inner">
    <header>
  <a href="http://git-scm.com/"><img src="../../../images/logo%402x.png" width="110" height="46" alt="Git" /></a>
  <span id="tagline">
    <em>--</em>everything-is-local
  </span>

  <form id="search" action="http://git-scm.com/search/results">
    <input id="search-text" name="search" placeholder="Search entire site..." autocomplete="off" type="text" />
  </form>
  <div id="search-results"></div>
</header>
  </div> <!-- .inner -->

    <div class="inner">
      <div id="content-wrapper">
        <aside class="sidebar">
  <nav>
    <ul>
      <li>
        <a href="http://git-scm.com/about">About</a>
      </li>
      <li>
        <a class="active" href="http://git-scm.com/doc">Documentation</a>
        <ul class="expanded">
          <li>
            <a href="http://git-scm.com/docs">Reference</a>
          </li>
          <li>
            <a href="http://git-scm.com/book">Book</a>
          </li>
          <li>
            <a href="http://git-scm.com/videos">Videos</a>
          </li>
          <li>
            <a href="http://git-scm.com/doc/ext">External Links</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="http://git-scm.com/blog">Blog</a>
      </li>
      <li>
        <a href="http://git-scm.com/downloads">Downloads</a>
        <ul class="">
          <li>
            <a href="http://git-scm.com/downloads/guis">GUI Clients</a>
          </li>
          <li>
            <a href="http://git-scm.com/downloads/logos">Logos</a>
          </li>
        </ul>
      </li>
      <li>
        <a href="http://git-scm.com/community">Community</a>
      </li>
    </ul>
      <hr class="sidebar">
        <p>Download this book in <a href="https://progit2.s3.amazonaws.com/ja/2015-09-12-221ea/progit-ja.825.pdf">PDF</a>,
   <a href="https://progit2.s3.amazonaws.com/ja/2015-09-12-221ea/progit-ja.825.mobi" type="application/x-mobipocket-ebook">mobi</a>,
or <a href="https://progit2.s3.amazonaws.com/ja/2015-09-12-221ea/progit-ja.825.epub" type="application/epub+zip">ePub</a> form for free.</p>

  <p>
This book is translated into
  <a href="http://git-scm.com/book/de">Deutsch</a>,
  <a href="http://git-scm.com/book/zh">简体中文</a>,
  <a href="http://git-scm.com/book/zh-tw">正體中文</a>,
  <a href="http://git-scm.com/book/fr">Français</a>,
  <a href="http://git-scm.com/book/ja">日本語</a>,
  <a href="http://git-scm.com/book/nl">Nederlands</a>,
  <a href="http://git-scm.com/book/ru">Русский</a>,
  <a href="http://git-scm.com/book/ko">한국어</a>,
  <a href="http://git-scm.com/book/pt-br">Português (Brasil)</a> and
  <a href="http://git-scm.com/book/cs">Čeština</a>.
</p>
<p>
Partial translations available in
  <a href="http://git-scm.com/book/ar">Arabic</a>,
  <a href="http://git-scm.com/book/es">Español</a>,
  <a href="http://git-scm.com/book/id">Indonesian</a>,
  <a href="http://git-scm.com/book/it">Italiano</a>,
  <a href="http://git-scm.com/book/fi">Suomi</a>,
  <a href="http://git-scm.com/book/mk">Македонски</a>,
  <a href="http://git-scm.com/book/pl">Polski</a> and
  <a href="http://git-scm.com/book/tr">Türkçe</a>.
</p>
<p>
Translations started for
  <a href="http://git-scm.com/book/az">Azərbaycan dili</a>,
  <a href="http://git-scm.com/book/be">Беларуская</a>,
  <a href="http://git-scm.com/book/ca">Català</a>,
  <a href="http://git-scm.com/book/eo">Esperanto</a>,
  <a href="http://git-scm.com/book/es-ni">Español (Nicaragua)</a>,
  <a href="http://git-scm.com/book/fa" dir="rtl">فارسی</a>,
  <a href="http://git-scm.com/book/hi">हिन्दी</a>,
  <a href="http://git-scm.com/book/hu">Magyar</a>,
  <a href="http://git-scm.com/book/no-nb">Norwegian Bokmål</a>,
  <a href="http://git-scm.com/book/ro">Română</a>,
  <a href="http://git-scm.com/book/sr">Српски</a>,
  <a href="http://git-scm.com/book/th">ภาษาไทย</a>,
  <a href="http://git-scm.com/book/vi">Tiếng Việt</a>,
  <a href="http://git-scm.com/book/uk">Українська</a> and
  <a href="http://git-scm.com/book/uz/v2">Ўзбекча</a>.
</p>
<hr class="sidebar"/>
<p>
The source of this book is <a href="https://github.com/progit/progit2">hosted on GitHub.</a></br>
Patches, suggestions and comments are welcome.
</p>

  

  </nav>
</aside>
        <div id="content">
          

<div id='book-chapters'>
  <a class="dropdown-trigger" id="book-chapters-trigger" data-panel-id="chapters-dropdown" href="#">Chapters ▾</a>
<div class='dropdown-panel' id='chapters-dropdown'>
  <div class="three-column">
    <div class='column-left'>
      <ol class='book-toc'>
  <li class='chapter'>
  <h2>1. <a href="%e4%bd%bf%e3%81%84%e5%a7%8b%e3%82%81%e3%82%8b-%e3%83%90%e3%83%bc%e3%82%b8%e3%83%a7%e3%83%b3%e7%ae%a1%e7%90%86%e3%81%ab%e9%96%a2%e3%81%97%e3%81%a6.html">使い始める</a></h2>
    <ol>
          <li>
            1.1
            <a href="%e4%bd%bf%e3%81%84%e5%a7%8b%e3%82%81%e3%82%8b-%e3%83%90%e3%83%bc%e3%82%b8%e3%83%a7%e3%83%b3%e7%ae%a1%e7%90%86%e3%81%ab%e9%96%a2%e3%81%97%e3%81%a6.html">バージョン管理に関して</a>
          </li>
          <li>
            1.2
            <a href="%e4%bd%bf%e3%81%84%e5%a7%8b%e3%82%81%e3%82%8b-Git%e7%95%a5%e5%8f%b2.html">Git略史</a>
          </li>
          <li>
            1.3
            <a href="%e4%bd%bf%e3%81%84%e5%a7%8b%e3%82%81%e3%82%8b-Git%e3%81%ae%e5%9f%ba%e6%9c%ac.html">Gitの基本</a>
          </li>
          <li>
            1.4
            <a href="%e4%bd%bf%e3%81%84%e5%a7%8b%e3%82%81%e3%82%8b-%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e3%83%a9%e3%82%a4%e3%83%b3.html">コマンドライン</a>
          </li>
          <li>
            1.5
            <a href="%e4%bd%bf%e3%81%84%e5%a7%8b%e3%82%81%e3%82%8b-Git%e3%81%ae%e3%82%a4%e3%83%b3%e3%82%b9%e3%83%88%e3%83%bc%e3%83%ab.html">Gitのインストール</a>
          </li>
          <li>
            1.6
            <a href="%e4%bd%bf%e3%81%84%e5%a7%8b%e3%82%81%e3%82%8b-%e6%9c%80%e5%88%9d%e3%81%aeGit%e3%81%ae%e6%a7%8b%e6%88%90.html">最初のGitの構成</a>
          </li>
          <li>
            1.7
            <a href="%e4%bd%bf%e3%81%84%e5%a7%8b%e3%82%81%e3%82%8b-%e3%83%98%e3%83%ab%e3%83%97%e3%82%92%e8%a6%8b%e3%82%8b.html">ヘルプを見る</a>
          </li>
          <li>
            1.8
            <a href="%e4%bd%bf%e3%81%84%e5%a7%8b%e3%82%81%e3%82%8b-%e3%81%be%e3%81%a8%e3%82%81.html">まとめ</a>
          </li>
    </ol>
  </li>
  <li class='chapter'>
  <h2>2. <a href="Git-%e3%81%ae%e5%9f%ba%e6%9c%ac-Git-%e3%83%aa%e3%83%9d%e3%82%b8%e3%83%88%e3%83%aa%e3%81%ae%e5%8f%96%e5%be%97.html">Git の基本</a></h2>
    <ol>
          <li>
            2.1
            <a href="Git-%e3%81%ae%e5%9f%ba%e6%9c%ac-Git-%e3%83%aa%e3%83%9d%e3%82%b8%e3%83%88%e3%83%aa%e3%81%ae%e5%8f%96%e5%be%97.html">Git リポジトリの取得</a>
          </li>
          <li>
            2.2
            <a href="Git-%e3%81%ae%e5%9f%ba%e6%9c%ac-%e5%a4%89%e6%9b%b4%e5%86%85%e5%ae%b9%e3%81%ae%e3%83%aa%e3%83%9d%e3%82%b8%e3%83%88%e3%83%aa%e3%81%b8%e3%81%ae%e8%a8%98%e9%8c%b2.html">変更内容のリポジトリへの記録</a>
          </li>
          <li>
            2.3
            <a href="Git-%e3%81%ae%e5%9f%ba%e6%9c%ac-%e3%82%b3%e3%83%9f%e3%83%83%e3%83%88%e5%b1%a5%e6%ad%b4%e3%81%ae%e9%96%b2%e8%a6%a7.html">コミット履歴の閲覧</a>
          </li>
          <li>
            2.4
            <a href="Git-%e3%81%ae%e5%9f%ba%e6%9c%ac-%e4%bd%9c%e6%a5%ad%e3%81%ae%e3%82%84%e3%82%8a%e7%9b%b4%e3%81%97.html">作業のやり直し</a>
          </li>
          <li>
            2.5
            <a href="Git-%e3%81%ae%e5%9f%ba%e6%9c%ac-%e3%83%aa%e3%83%a2%e3%83%bc%e3%83%88%e3%81%a7%e3%81%ae%e4%bd%9c%e6%a5%ad.html">リモートでの作業</a>
          </li>
          <li>
            2.6
            <a href="Git-%e3%81%ae%e5%9f%ba%e6%9c%ac-%e3%82%bf%e3%82%b0.html">タグ</a>
          </li>
          <li>
            2.7
            <a href="Git-%e3%81%ae%e5%9f%ba%e6%9c%ac-Git-%e3%82%a8%e3%82%a4%e3%83%aa%e3%82%a2%e3%82%b9.html">Git エイリアス</a>
          </li>
          <li>
            2.8
            <a href="Git-%e3%81%ae%e5%9f%ba%e6%9c%ac-%e3%81%be%e3%81%a8%e3%82%81.html">まとめ</a>
          </li>
    </ol>
  </li>
  <li class='chapter'>
  <h2>3. <a href="Git-%e3%81%ae%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e6%a9%9f%e8%83%bd-%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e3%81%a8%e3%81%af.html">Git のブランチ機能</a></h2>
    <ol>
          <li>
            3.1
            <a href="Git-%e3%81%ae%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e6%a9%9f%e8%83%bd-%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e3%81%a8%e3%81%af.html">ブランチとは</a>
          </li>
          <li>
            3.2
            <a href="Git-%e3%81%ae%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e6%a9%9f%e8%83%bd-%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e3%81%a8%e3%83%9e%e3%83%bc%e3%82%b8%e3%81%ae%e5%9f%ba%e6%9c%ac.html">ブランチとマージの基本</a>
          </li>
          <li>
            3.3
            <a href="Git-%e3%81%ae%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e6%a9%9f%e8%83%bd-%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e3%81%ae%e7%ae%a1%e7%90%86.html">ブランチの管理</a>
          </li>
          <li>
            3.4
            <a href="Git-%e3%81%ae%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e6%a9%9f%e8%83%bd-%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e3%81%a7%e3%81%ae%e4%bd%9c%e6%a5%ad%e3%81%ae%e6%b5%81%e3%82%8c.html">ブランチでの作業の流れ</a>
          </li>
          <li>
            3.5
            <a href="Git-%e3%81%ae%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e6%a9%9f%e8%83%bd-%e3%83%aa%e3%83%a2%e3%83%bc%e3%83%88%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81.html">リモートブランチ</a>
          </li>
          <li>
            3.6
            <a href="Git-%e3%81%ae%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e6%a9%9f%e8%83%bd-%e3%83%aa%e3%83%99%e3%83%bc%e3%82%b9.html">リベース</a>
          </li>
          <li>
            3.7
            <a href="Git-%e3%81%ae%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e6%a9%9f%e8%83%bd-%e3%81%be%e3%81%a8%e3%82%81.html">まとめ</a>
          </li>
    </ol>
  </li>
  <li class='chapter'>
  <h2>4. <a href="Git%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc-%e3%83%97%e3%83%ad%e3%83%88%e3%82%b3%e3%83%ab.html">Gitサーバー</a></h2>
    <ol>
          <li>
            4.1
            <a href="Git%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc-%e3%83%97%e3%83%ad%e3%83%88%e3%82%b3%e3%83%ab.html">プロトコル</a>
          </li>
          <li>
            4.2
            <a href="Git%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc-%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc%e7%94%a8%e3%81%ae-Git-%e3%81%ae%e5%8f%96%e5%be%97.html">サーバー用の Git の取得</a>
          </li>
          <li>
            4.3
            <a href="Git%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc-SSH-%e5%85%ac%e9%96%8b%e9%8d%b5%e3%81%ae%e4%bd%9c%e6%88%90.html">SSH 公開鍵の作成</a>
          </li>
          <li>
            4.4
            <a href="Git%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc-%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc%e3%81%ae%e3%82%bb%e3%83%83%e3%83%88%e3%82%a2%e3%83%83%e3%83%97.html">サーバーのセットアップ</a>
          </li>
          <li>
            4.5
            <a href="Git%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc-Git-%e3%83%87%e3%83%bc%e3%83%a2%e3%83%b3.html">Git デーモン</a>
          </li>
          <li>
            4.6
            <a href="Git%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc-Smart-HTTP.html">Smart HTTP</a>
          </li>
          <li>
            4.7
            <a href="Git%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc-GitWeb.html">GitWeb</a>
          </li>
          <li>
            4.8
            <a href="Git%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc-GitLab.html">GitLab</a>
          </li>
          <li>
            4.9
            <a href="Git%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc-%e3%82%b5%e3%83%bc%e3%83%89%e3%83%91%e3%83%bc%e3%83%86%e3%82%a3%e3%81%ab%e3%82%88%e3%82%8b-Git-%e3%83%9b%e3%82%b9%e3%83%86%e3%82%a3%e3%83%b3%e3%82%b0.html">サードパーティによる Git ホスティング</a>
          </li>
          <li>
            4.10
            <a href="Git%e3%82%b5%e3%83%bc%e3%83%90%e3%83%bc-%e3%81%be%e3%81%a8%e3%82%81.html">まとめ</a>
          </li>
    </ol>
  </li>
  <li class='chapter'>
  <h2>5. <a href="Git-%e3%81%a7%e3%81%ae%e5%88%86%e6%95%a3%e4%bd%9c%e6%a5%ad-%e5%88%86%e6%95%a3%e4%bd%9c%e6%a5%ad%e3%81%ae%e6%b5%81%e3%82%8c.html">Git での分散作業</a></h2>
    <ol>
          <li>
            5.1
            <a href="Git-%e3%81%a7%e3%81%ae%e5%88%86%e6%95%a3%e4%bd%9c%e6%a5%ad-%e5%88%86%e6%95%a3%e4%bd%9c%e6%a5%ad%e3%81%ae%e6%b5%81%e3%82%8c.html">分散作業の流れ</a>
          </li>
          <li>
            5.2
            <a href="Git-%e3%81%a7%e3%81%ae%e5%88%86%e6%95%a3%e4%bd%9c%e6%a5%ad-%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%b8%e3%81%ae%e8%b2%a2%e7%8c%ae.html">プロジェクトへの貢献</a>
          </li>
          <li>
            5.3
            <a href="Git-%e3%81%a7%e3%81%ae%e5%88%86%e6%95%a3%e4%bd%9c%e6%a5%ad-%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ae%e9%81%8b%e5%96%b6.html">プロジェクトの運営</a>
          </li>
          <li>
            5.4
            <a href="Git-%e3%81%a7%e3%81%ae%e5%88%86%e6%95%a3%e4%bd%9c%e6%a5%ad-%e3%81%be%e3%81%a8%e3%82%81.html">まとめ</a>
          </li>
    </ol>
  </li>
</ol>

    </div>
    <div class='column-middle'>
      <ol class='book-toc'>
  <li class='chapter'>
  <h2>6. <a href="GitHub-%e3%82%a2%e3%82%ab%e3%82%a6%e3%83%b3%e3%83%88%e3%81%ae%e6%ba%96%e5%82%99%e3%81%a8%e8%a8%ad%e5%ae%9a.html">GitHub</a></h2>
    <ol>
          <li>
            6.1
            <a href="GitHub-%e3%82%a2%e3%82%ab%e3%82%a6%e3%83%b3%e3%83%88%e3%81%ae%e6%ba%96%e5%82%99%e3%81%a8%e8%a8%ad%e5%ae%9a.html">アカウントの準備と設定</a>
          </li>
          <li>
            6.2
            <a href="GitHub-%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%b8%e3%81%ae%e8%b2%a2%e7%8c%ae.html">プロジェクトへの貢献</a>
          </li>
          <li>
            6.3
            <a href="GitHub-%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ae%e3%83%a1%e3%83%b3%e3%83%86%e3%83%8a%e3%83%b3%e3%82%b9.html">プロジェクトのメンテナンス</a>
          </li>
          <li>
            6.4
            <a href="GitHub-%e7%b5%84%e7%b9%94%e3%81%ae%e7%ae%a1%e7%90%86.html">組織の管理</a>
          </li>
          <li>
            6.5
            <a href="GitHub-%e3%82%b9%e3%82%af%e3%83%aa%e3%83%97%e3%83%88%e3%81%ab%e3%82%88%e3%82%8b-GitHub-%e3%81%ae%e6%93%8d%e4%bd%9c.html">スクリプトによる GitHub の操作</a>
          </li>
          <li>
            6.6
            <a href="GitHub-%e3%81%be%e3%81%a8%e3%82%81.html">まとめ</a>
          </li>
    </ol>
  </li>
  <li class='chapter'>
  <h2>7. <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e3%83%aa%e3%83%93%e3%82%b8%e3%83%a7%e3%83%b3%e3%81%ae%e9%81%b8%e6%8a%9e.html">Git のさまざまなツール</a></h2>
    <ol>
          <li>
            7.1
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e3%83%aa%e3%83%93%e3%82%b8%e3%83%a7%e3%83%b3%e3%81%ae%e9%81%b8%e6%8a%9e.html">リビジョンの選択</a>
          </li>
          <li>
            7.2
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e5%af%be%e8%a9%b1%e7%9a%84%e3%81%aa%e3%82%b9%e3%83%86%e3%83%bc%e3%82%b8%e3%83%b3%e3%82%b0.html">対話的なステージング</a>
          </li>
          <li>
            7.3
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e4%bd%9c%e6%a5%ad%e3%81%ae%e9%9a%a0%e3%81%97%e3%81%8b%e3%81%9f%e3%81%a8%e6%b6%88%e3%81%97%e3%81%8b%e3%81%9f.html">作業の隠しかたと消しかた</a>
          </li>
          <li>
            7.4
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e4%bd%9c%e6%a5%ad%e5%86%85%e5%ae%b9%e3%81%b8%e3%81%ae%e7%bd%b2%e5%90%8d.html">作業内容への署名</a>
          </li>
          <li>
            7.5
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e6%a4%9c%e7%b4%a2.html">検索</a>
          </li>
          <li>
            7.6
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e6%ad%b4%e5%8f%b2%e3%81%ae%e6%9b%b8%e3%81%8d%e6%8f%9b%e3%81%88.html">歴史の書き換え</a>
          </li>
          <li>
            7.7
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e3%83%aa%e3%82%bb%e3%83%83%e3%83%88%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e8%a9%b3%e8%aa%ac.html">リセットコマンド詳説</a>
          </li>
          <li>
            7.8
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e9%ab%98%e5%ba%a6%e3%81%aa%e3%83%9e%e3%83%bc%e3%82%b8%e6%89%8b%e6%b3%95.html">高度なマージ手法</a>
          </li>
          <li>
            7.9
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-Rerere.html">Rerere</a>
          </li>
          <li>
            7.10
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-Git-%e3%81%ab%e3%82%88%e3%82%8b%e3%83%87%e3%83%90%e3%83%83%e3%82%b0.html">Git によるデバッグ</a>
          </li>
          <li>
            7.11
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e3%82%b5%e3%83%96%e3%83%a2%e3%82%b8%e3%83%a5%e3%83%bc%e3%83%ab.html">サブモジュール</a>
          </li>
          <li>
            7.12
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e3%83%90%e3%83%b3%e3%83%89%e3%83%ab%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab%e3%81%ae%e4%bd%9c%e6%88%90.html">バンドルファイルの作成</a>
          </li>
          <li>
            7.13
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-Git-%e3%82%aa%e3%83%96%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ae%e7%bd%ae%e3%81%8d%e6%8f%9b%e3%81%88.html">Git オブジェクトの置き換え</a>
          </li>
          <li>
            7.14
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e8%aa%8d%e8%a8%bc%e6%83%85%e5%a0%b1%e3%81%ae%e4%bf%9d%e5%ad%98.html">認証情報の保存</a>
          </li>
          <li>
            7.15
            <a href="Git-%e3%81%ae%e3%81%95%e3%81%be%e3%81%96%e3%81%be%e3%81%aa%e3%83%84%e3%83%bc%e3%83%ab-%e3%81%be%e3%81%a8%e3%82%81.html">まとめ</a>
          </li>
    </ol>
  </li>
  <li class='chapter'>
  <h2>8. <a href="Git-%e3%81%ae%e3%82%ab%e3%82%b9%e3%82%bf%e3%83%9e%e3%82%a4%e3%82%ba-Git-%e3%81%ae%e8%a8%ad%e5%ae%9a.html">Git のカスタマイズ</a></h2>
    <ol>
          <li>
            8.1
            <a href="Git-%e3%81%ae%e3%82%ab%e3%82%b9%e3%82%bf%e3%83%9e%e3%82%a4%e3%82%ba-Git-%e3%81%ae%e8%a8%ad%e5%ae%9a.html">Git の設定</a>
          </li>
          <li>
            8.2
            <a href="Git-%e3%81%ae%e3%82%ab%e3%82%b9%e3%82%bf%e3%83%9e%e3%82%a4%e3%82%ba-Git-%e3%81%ae%e5%b1%9e%e6%80%a7.html">Git の属性</a>
          </li>
          <li>
            8.3
            <a href="Git-%e3%81%ae%e3%82%ab%e3%82%b9%e3%82%bf%e3%83%9e%e3%82%a4%e3%82%ba-Git-%e3%83%95%e3%83%83%e3%82%af.html">Git フック</a>
          </li>
          <li>
            8.4
            <a href="Git-%e3%81%ae%e3%82%ab%e3%82%b9%e3%82%bf%e3%83%9e%e3%82%a4%e3%82%ba-Git-%e3%83%9d%e3%83%aa%e3%82%b7%e3%83%bc%e3%81%ae%e5%ae%9f%e6%96%bd%e4%be%8b.html">Git ポリシーの実施例</a>
          </li>
          <li>
            8.5
            <a href="Git-%e3%81%ae%e3%82%ab%e3%82%b9%e3%82%bf%e3%83%9e%e3%82%a4%e3%82%ba-%e3%81%be%e3%81%a8%e3%82%81.html">まとめ</a>
          </li>
    </ol>
  </li>
  <li class='chapter'>
  <h2>9. <a href="Git%e3%81%a8%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e3%81%ae%e9%80%a3%e6%90%ba-Git-%e3%82%92%e3%82%af%e3%83%a9%e3%82%a4%e3%82%a2%e3%83%b3%e3%83%88%e3%81%a8%e3%81%97%e3%81%a6%e4%bd%bf%e7%94%a8%e3%81%99%e3%82%8b.html">Gitとその他のシステムの連携</a></h2>
    <ol>
          <li>
            9.1
            <a href="Git%e3%81%a8%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e3%81%ae%e9%80%a3%e6%90%ba-Git-%e3%82%92%e3%82%af%e3%83%a9%e3%82%a4%e3%82%a2%e3%83%b3%e3%83%88%e3%81%a8%e3%81%97%e3%81%a6%e4%bd%bf%e7%94%a8%e3%81%99%e3%82%8b.html">Git をクライアントとして使用する</a>
          </li>
          <li>
            9.2
            <a href="Git%e3%81%a8%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e3%81%ae%e9%80%a3%e6%90%ba-Git-%e3%81%b8%e7%a7%bb%e8%a1%8c%e3%81%99%e3%82%8b.html">Git へ移行する</a>
          </li>
          <li>
            9.3
            <a href="Git%e3%81%a8%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e3%81%ae%e9%80%a3%e6%90%ba-%e3%81%be%e3%81%a8%e3%82%81.html">まとめ</a>
          </li>
    </ol>
  </li>
  <li class='chapter'>
  <h2>10. <a href="Git%e3%81%ae%e5%86%85%e5%81%b4-%e9%85%8d%e7%ae%a1%ef%bc%88Plumbing%ef%bc%89%e3%81%a8%e7%a3%81%e5%99%a8%ef%bc%88Porcelain%ef%bc%89.html">Gitの内側</a></h2>
    <ol>
          <li>
            10.1
            <a href="Git%e3%81%ae%e5%86%85%e5%81%b4-%e9%85%8d%e7%ae%a1%ef%bc%88Plumbing%ef%bc%89%e3%81%a8%e7%a3%81%e5%99%a8%ef%bc%88Porcelain%ef%bc%89.html">配管（Plumbing）と磁器（Porcelain）</a>
          </li>
          <li>
            10.2
            <a href="Git%e3%81%ae%e5%86%85%e5%81%b4-Git%e3%82%aa%e3%83%96%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88.html">Gitオブジェクト</a>
          </li>
          <li>
            10.3
            <a href="Git%e3%81%ae%e5%86%85%e5%81%b4-Git%e3%81%ae%e5%8f%82%e7%85%a7.html">Gitの参照</a>
          </li>
          <li>
            10.4
            <a href="Git%e3%81%ae%e5%86%85%e5%81%b4-%e3%83%91%e3%83%83%e3%82%af%e3%83%95%e3%82%a1%e3%82%a4%e3%83%ab.html">パックファイル</a>
          </li>
          <li>
            10.5
            <a href="Git%e3%81%ae%e5%86%85%e5%81%b4-%e5%8f%82%e7%85%a7%e4%bb%95%e6%a7%98%ef%bc%88Refspec%ef%bc%89.html">参照仕様（Refspec）</a>
          </li>
          <li>
            10.6
            <a href="Git%e3%81%ae%e5%86%85%e5%81%b4-%e3%83%88%e3%83%a9%e3%83%b3%e3%82%b9%e3%83%95%e3%82%a1%e3%83%bc%e3%83%97%e3%83%ad%e3%83%88%e3%82%b3%e3%83%ab.html">トランスファープロトコル</a>
          </li>
          <li>
            10.7
            <a href="Git%e3%81%ae%e5%86%85%e5%81%b4-%e3%83%a1%e3%82%a4%e3%83%b3%e3%83%86%e3%83%8a%e3%83%b3%e3%82%b9%e3%81%a8%e3%83%87%e3%83%bc%e3%82%bf%e3%83%aa%e3%82%ab%e3%83%90%e3%83%aa.html">メインテナンスとデータリカバリ</a>
          </li>
          <li>
            10.8
            <a href="Git%e3%81%ae%e5%86%85%e5%81%b4-%e7%92%b0%e5%a2%83%e5%a4%89%e6%95%b0.html">環境変数</a>
          </li>
          <li>
            10.9
            <a href="Git%e3%81%ae%e5%86%85%e5%81%b4-%e8%a6%81%e7%b4%84.html">要約</a>
          </li>
    </ol>
  </li>
</ol>

    </div>
    <div class='column-right'>
      <ol class='book-toc'>
  <li class='chapter'>
  <h2>A1. <a href="%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e7%92%b0%e5%a2%83%e3%81%a7%e3%81%aeGit-%e3%82%b0%e3%83%a9%e3%83%95%e3%82%a3%e3%82%ab%e3%83%ab%e3%82%a4%e3%83%b3%e3%82%bf%e3%83%95%e3%82%a7%e3%83%bc%e3%82%b9.html">その他の環境でのGit</a></h2>
    <ol>
          <li>
            A1.1
            <a href="%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e7%92%b0%e5%a2%83%e3%81%a7%e3%81%aeGit-%e3%82%b0%e3%83%a9%e3%83%95%e3%82%a3%e3%82%ab%e3%83%ab%e3%82%a4%e3%83%b3%e3%82%bf%e3%83%95%e3%82%a7%e3%83%bc%e3%82%b9.html">グラフィカルインタフェース</a>
          </li>
          <li>
            A1.2
            <a href="%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e7%92%b0%e5%a2%83%e3%81%a7%e3%81%aeGit-Visual-Studio%e3%81%a7Git%e3%82%92%e4%bd%bf%e3%81%86.html">Visual StudioでGitを使う</a>
          </li>
          <li>
            A1.3
            <a href="%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e7%92%b0%e5%a2%83%e3%81%a7%e3%81%aeGit-Eclipse%e3%81%a7Git%e3%82%92%e4%bd%bf%e3%81%86.html">EclipseでGitを使う</a>
          </li>
          <li>
            A1.4
            <a href="%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e7%92%b0%e5%a2%83%e3%81%a7%e3%81%aeGit-Bash%e3%81%a7Git%e3%82%92%e4%bd%bf%e3%81%86.html">BashでGitを使う</a>
          </li>
          <li>
            A1.5
            <a href="%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e7%92%b0%e5%a2%83%e3%81%a7%e3%81%aeGit-Zsh%e3%81%a7Git%e3%82%92%e4%bd%bf%e3%81%86.html">ZshでGitを使う</a>
          </li>
          <li>
            A1.6
            <a href="%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e7%92%b0%e5%a2%83%e3%81%a7%e3%81%aeGit-Powershell%e3%81%a7Git%e3%82%92%e4%bd%bf%e3%81%86.html">PowershellでGitを使う</a>
          </li>
          <li>
            A1.7
            <a href="%e3%81%9d%e3%81%ae%e4%bb%96%e3%81%ae%e7%92%b0%e5%a2%83%e3%81%a7%e3%81%aeGit-%e3%81%be%e3%81%a8%e3%82%81.html">まとめ</a>
          </li>
    </ol>
  </li>
  <li class='chapter'>
  <h2>A2. <a href="Git%e3%82%92%e3%81%82%e3%81%aa%e3%81%9f%e3%81%ae%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ab%e7%b5%84%e3%81%bf%e8%be%bc%e3%82%80-Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e3%83%a9%e3%82%a4%e3%83%b3%e3%83%84%e3%83%bc%e3%83%ab%e3%82%92%e4%bd%bf%e3%81%86%e6%96%b9%e6%b3%95.html">Gitをあなたのアプリケーションに組み込む</a></h2>
    <ol>
          <li>
            A2.1
            <a href="Git%e3%82%92%e3%81%82%e3%81%aa%e3%81%9f%e3%81%ae%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ab%e7%b5%84%e3%81%bf%e8%be%bc%e3%82%80-Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89%e3%83%a9%e3%82%a4%e3%83%b3%e3%83%84%e3%83%bc%e3%83%ab%e3%82%92%e4%bd%bf%e3%81%86%e6%96%b9%e6%b3%95.html">Gitのコマンドラインツールを使う方法</a>
          </li>
          <li>
            A2.2
            <a href="Git%e3%82%92%e3%81%82%e3%81%aa%e3%81%9f%e3%81%ae%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ab%e7%b5%84%e3%81%bf%e8%be%bc%e3%82%80-Libgit2%e3%82%92%e4%bd%bf%e3%81%86%e6%96%b9%e6%b3%95.html">Libgit2を使う方法</a>
          </li>
          <li>
            A2.3
            <a href="Git%e3%82%92%e3%81%82%e3%81%aa%e3%81%9f%e3%81%ae%e3%82%a2%e3%83%97%e3%83%aa%e3%82%b1%e3%83%bc%e3%82%b7%e3%83%a7%e3%83%b3%e3%81%ab%e7%b5%84%e3%81%bf%e8%be%bc%e3%82%80-JGit.html">JGit</a>
          </li>
    </ol>
  </li>
  <li class='chapter'>
  <h2>A3. <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e3%82%bb%e3%83%83%e3%83%88%e3%82%a2%e3%83%83%e3%83%97%e3%81%a8%e8%a8%ad%e5%ae%9a.html">Gitのコマンド</a></h2>
    <ol>
          <li>
            A3.1
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e3%82%bb%e3%83%83%e3%83%88%e3%82%a2%e3%83%83%e3%83%97%e3%81%a8%e8%a8%ad%e5%ae%9a.html">セットアップと設定</a>
          </li>
          <li>
            A3.2
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ae%e5%8f%96%e5%be%97%e3%81%a8%e4%bd%9c%e6%88%90.html">プロジェクトの取得と作成</a>
          </li>
          <li>
            A3.3
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e5%9f%ba%e6%9c%ac%e7%9a%84%e3%81%aa%e3%82%b9%e3%83%8a%e3%83%83%e3%83%97%e3%82%b7%e3%83%a7%e3%83%83%e3%83%88.html">基本的なスナップショット</a>
          </li>
          <li>
            A3.4
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e3%83%96%e3%83%a9%e3%83%b3%e3%83%81%e3%81%a8%e3%83%9e%e3%83%bc%e3%82%b8.html">ブランチとマージ</a>
          </li>
          <li>
            A3.5
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e3%83%97%e3%83%ad%e3%82%b8%e3%82%a7%e3%82%af%e3%83%88%e3%81%ae%e5%85%b1%e6%9c%89%e3%81%a8%e3%82%a2%e3%83%83%e3%83%97%e3%83%87%e3%83%bc%e3%83%88.html">プロジェクトの共有とアップデート</a>
          </li>
          <li>
            A3.6
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e6%a4%9c%e6%9f%bb%e3%81%a8%e6%af%94%e8%bc%83.html">検査と比較</a>
          </li>
          <li>
            A3.7
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e3%83%87%e3%83%90%e3%83%83%e3%82%b0.html">デバッグ</a>
          </li>
          <li>
            A3.8
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e3%83%91%e3%83%83%e3%83%81%e3%81%ae%e9%81%a9%e7%94%a8.html">パッチの適用</a>
          </li>
          <li>
            A3.9
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e3%83%a1%e3%83%bc%e3%83%ab.html">メール</a>
          </li>
          <li>
            A3.10
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e5%a4%96%e9%83%a8%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0.html">外部システム</a>
          </li>
          <li>
            A3.11
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e3%82%b7%e3%82%b9%e3%83%86%e3%83%a0%e7%ae%a1%e7%90%86.html">システム管理</a>
          </li>
          <li>
            A3.12
            <a href="Git%e3%81%ae%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89-%e9%85%8d%e7%ae%a1%e3%82%b3%e3%83%9e%e3%83%b3%e3%83%89.html">配管コマンド</a>
          </li>
    </ol>
  </li>
</ol>

    </div>
  </div>
 </div>

    <span class="light" id="edition">
      2nd Edition
    </span>
</div>

<div id='main' class="book edition2">
    <h1>8.4 Git のカスタマイズ - Git ポリシーの実施例</h1>
  <div><a id="_an_example_git_enforced_policy"></a><h2>Git ポリシーの実施例</h2>

<p><a data-type="indexterm" data-primary="policy example" id="id-9Wc0UntgHn"></a></p>

<p>このセクションでは、これまでに学んだ内容を使って実際に Git のワークフローを確立してみます。
コミットメッセージの書式をチェックし、またプロジェクト内の特定のサブディレクトリを特定のユーザーだけが変更できるようにします。
以降では、開発者に対して「なぜプッシュが却下されたのか」を伝えるためのクライアントスクリプトと、ポリシーを強制するためのサーバースクリプトを作成していきます。</p>

<p>以降で示すスクリプトは Ruby で書かれています。理由としては、我々の知的習慣によるところもありますが、Ruby は（たとえ書けないとしても）読むのが簡単というのも理由のひとつです。
しかし、それ以外の言語であってもきちんと動作します。Git に同梱されているサンプルスクリプトはすべて Perl あるいは Bash で書かれています。サンプルスクリプトを見れば、それらの言語による大量のフックの例を見ることができます。</p>








<section data-type="sect2" id="-kaTDiyH5"><h3 id="サーバーサイドフック"><a href="#サーバーサイドフック">サーバーサイドフック</a></h3>

<p>サーバーサイドで行う処理は、すべて <code>hooks</code> ディレクトリの <code>update</code> ファイルにまとめます。
<code>update</code> ファイルはプッシュされるブランチごとに実行され、次の3つの引数を取ります。</p>

<ul>
<li>
<p>プッシュされる参照の名前</p>
</li>
<li>
<p>操作前のブランチのリビジョン</p>
</li>
<li>
<p>プッシュされる新しいリビジョン</p>
</li>
</ul>
<p>また、SSH 経由でのプッシュの場合は、プッシュしたユーザーを知ることもできます。
全員に共通のユーザー（ “git” など）を使って公開鍵認証をしている場合は、公開鍵の情報に基づいて実際のユーザーを判断して環境変数を設定するというラッパーが必要です。
ここでは、接続しているユーザー名が環境変数 <code>$USER</code> に格納されているものとします。 <code>update</code> スクリプトは、まず必要な情報を取得するところから始まります。</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="c1">#!/usr/bin/env ruby</code>

<code class="vg">$refname</code> <code class="o">=</code> <code class="no">ARGV</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code>
<code class="vg">$oldrev</code>  <code class="o">=</code> <code class="no">ARGV</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code>
<code class="vg">$newrev</code>  <code class="o">=</code> <code class="no">ARGV</code><code class="o">[</code><code class="mi">2</code><code class="o">]</code>
<code class="vg">$user</code>    <code class="o">=</code> <code class="no">ENV</code><code class="o">[</code><code class="s1">'USER'</code><code class="o">]</code>

<code class="nb">puts</code> <code class="s2">"Enforcing Policies..."</code>
<code class="nb">puts</code> <code class="s2">"(</code><code class="si">#{</code><code class="vg">$refname</code><code class="si">}</code><code class="s2">) (</code><code class="si">#{</code><code class="vg">$oldrev</code><code class="o">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">6</code><code class="o">]</code><code class="si">}</code><code class="s2">) (</code><code class="si">#{</code><code class="vg">$newrev</code><code class="o">[</code><code class="mi">0</code><code class="p">,</code><code class="mi">6</code><code class="o">]</code><code class="si">}</code><code class="s2">)"</code>
</pre>

<p>そう、グローバル変数を使ってますね。
が、責めないでください – 実例を示すには、こっちの方が簡単なんです。</p>










<section data-type="sect3" id="_enforcing_commit_message_format"><h4>特定のコミットメッセージ書式の強制</h4>

<p>まずは、コミットメッセージを特定の書式に従わせることに挑戦してみましょう。
ここでは、コミットメッセージには必ず “ref: 1234” 形式の文字列を含むこと、というルールにします。個々のコミットをチケットシステムの作業項目とリンクさせたいという意図です。
やらなければならないことは、プッシュされてきた各コミットのコミットメッセージに上記の文字列があるか調べ、なければゼロ以外の値を返して終了し、プッシュを却下することです。</p>

<p>プッシュされたすべてのコミットの SHA-1 値を取得するには、<code>$newrev</code> と <code>$oldrev</code> の内容を <code>git rev-list</code> という Git の配管（plumbing）コマンドに渡します。
これは基本的には <code>git log</code> コマンドのようなものですが、デフォルトでは SHA-1 値だけを表示してそれ以外の情報は出力しません。
ふたつのコミットの間のすべてのコミットの SHA-1 を得るには、次のようなコマンドを実行します。</p>

<pre data-type="programlisting" data-code-language="console"><code class="gp">$</code> git rev-list 538c33..d14fc7
<code class="go">d14fc7c847ab946ec39590d87783c69b031bdfb7</code>
<code class="go">9f585da4401b0a3999e84113824d15245c13f0be</code>
<code class="go">234071a1be950e2a8d078e6141f5cd20c1e61ad3</code>
<code class="go">dfa04c9ef3d5197182f13fb5b9b1fb7717d2222a</code>
<code class="go">17716ec0f1ff5c77eff40b7fe912f9f6cfd0e475</code>
</pre>

<p>この出力を受け取って、ループさせて各コミットの SHA-1 を取得し、個々のメッセージを取り出せば、正規表現でそのメッセージを調べることができます。</p>

<p>さて、これらのコミットからコミットメッセージを取り出す方法を見つけなければなりません。
生のコミットデータを取得するには、別の配管コマンド <code>git cat-file</code> を使います。
配管コマンドについては <a data-type="xref" href="1-git-internals/_git_internals">Gitの内側</a> で詳しく説明しますが、とりあえずはこのコマンドがどんな結果を返すのだけを示します。</p>

<pre data-type="programlisting" data-code-language="console"><code class="gp">$</code> git cat-file commit ca82a6
<code class="go">tree cfda3bf379e4f8dba8717dee55aab78aef7f4daf</code>
<code class="go">parent 085bb3bcb608e1e8451d4b2432f8ecbe6306e7e7</code>
<code class="go">author Scott Chacon &lt;schacon@gmail.com&gt; 1205815931 -0700</code>
<code class="go">committer Scott Chacon &lt;schacon@gmail.com&gt; 1240030591 -0700</code>

<code class="go">changed the version number</code>
</pre>

<p>SHA-1 値がわかっているときにコミットからコミットメッセージを得るシンプルな方法は、空行を探してそれ以降をすべて取得するというものです。
これには、Unix システムの <code>sed</code> コマンドが使えます。</p>

<pre data-type="programlisting" data-code-language="console"><code class="gp">$</code> git cat-file commit ca82a6 <code class="p">|</code> sed <code class="s1">'1,/^$/d'</code>
<code class="go">changed the version number</code>
</pre>

<p>プッシュしようとしているコミットから、この呪文を使ってコミットメッセージを取得し、もし条件にマッチしないものがあれば終了させればよいのです。
スクリプトを抜けてプッシュを却下するには、ゼロ以外の値を返して終了します。
以上を踏まえると、このメソッドは次のようになります。</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="vg">$regex</code> <code class="o">=</code> <code class="sr">/\[ref: (\d+)\]/</code>

<code class="c1"># enforced custom commit message format</code>
<code class="k">def</code> <code class="nf">check_message_format</code>
  <code class="n">missed_revs</code> <code class="o">=</code> <code class="sb">`git rev-list </code><code class="si">#{</code><code class="vg">$oldrev</code><code class="si">}</code><code class="sb">..</code><code class="si">#{</code><code class="vg">$newrev</code><code class="si">}</code><code class="sb">`</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code>
  <code class="n">missed_revs</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">rev</code><code class="o">|</code>
    <code class="n">message</code> <code class="o">=</code> <code class="sb">`git cat-file commit </code><code class="si">#{</code><code class="n">rev</code><code class="si">}</code><code class="sb"> | sed '1,/^$/d'`</code>
    <code class="k">if</code> <code class="o">!</code><code class="vg">$regex</code><code class="o">.</code><code class="n">match</code><code class="p">(</code><code class="n">message</code><code class="p">)</code>
      <code class="nb">puts</code> <code class="s2">"[POLICY] Your message is not formatted correctly"</code>
      <code class="nb">exit</code> <code class="mi">1</code>
    <code class="k">end</code>
  <code class="k">end</code>
<code class="k">end</code>
<code class="n">check_message_format</code>
</pre>

<p>これを <code>update</code> スクリプトに追加すると、ルールを守らないコミットメッセージが含まれるコミットのプッシュを却下するようになります。</p>
</section><section data-type="sect3" id="-7kTvSqiWH4"><h4>ユーザーベースのアクセス制御</h4>

<p>アクセス制御リスト (ACL) を使って、ユーザーごとにプロジェクトのどの部分に対して変更をプッシュできるのかを指定できる仕組みを追加したいとしましょう。
全体にアクセスできるユーザーもいれば、特定のサブディレクトリやファイルにしか変更をプッシュできないユーザーもいる、といった具合です。
これを行うには、ルールを書いたファイル <code>acl</code> をサーバー上のベア Git リポジトリに置きます。
<code>update</code> フックにこのファイルを読ませ、プッシュされてきたコミットにどのようなファイルが含まれているのかを調べ、そしてプッシュしたユーザーにそのファイルを変更する権限があるのか判断します。</p>

<p>まずは ACL を作るところから始めましょう。
ここでは、CVS の ACL と似た書式を使います。これは各項目を一行で表し、最初のフィールドは <code>avail</code> あるいは <code>unavail</code>、そして次の行がそのルールを適用するユーザーの一覧（カンマ区切り）、そして最後のフィールドがそのルールを適用するパス（ブランクは全体へのアクセスを意味します）です。フィールドの区切りには、パイプ文字 (<code>|</code>) を使います。</p>

<p>ここでは、全体にアクセスできる管理者、 <code>doc</code> ディレクトリにアクセスできるドキュメント担当者、そして <code>lib</code> と <code>tests</code> ディレクトリだけにアクセスできる開発者を設定します。ACL ファイルは次のようになります。</p>

<pre data-type="programlisting">avail|nickh,pjhyett,defunkt,tpw
avail|usinclair,cdickens,ebronte|doc
avail|schacon|lib
avail|schacon|tests</pre>

<p>まずはこのデータを読み込んで、スクリプト内で使えるデータ構造にしてみましょう。
例をシンプルにするために、ここでは <code>avail</code> ディレクティブだけを使います。
次のメソッドは連想配列を返すものです。配列のキーはユーザー名、キーに対応する値はそのユーザーが書き込み権限を持つパスの配列になります。</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="k">def</code> <code class="nf">get_acl_access_data</code><code class="p">(</code><code class="n">acl_file</code><code class="p">)</code>
  <code class="c1"># read in ACL data</code>
  <code class="n">acl_file</code> <code class="o">=</code> <code class="no">File</code><code class="o">.</code><code class="n">read</code><code class="p">(</code><code class="n">acl_file</code><code class="p">)</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code><code class="o">.</code><code class="n">reject</code> <code class="p">{</code> <code class="o">|</code><code class="n">line</code><code class="o">|</code> <code class="n">line</code> <code class="o">==</code> <code class="s1">''</code> <code class="p">}</code>
  <code class="n">access</code> <code class="o">=</code> <code class="p">{}</code>
  <code class="n">acl_file</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">line</code><code class="o">|</code>
    <code class="n">avail</code><code class="p">,</code> <code class="n">users</code><code class="p">,</code> <code class="n">path</code> <code class="o">=</code> <code class="n">line</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s1">'|'</code><code class="p">)</code>
    <code class="k">next</code> <code class="k">unless</code> <code class="n">avail</code> <code class="o">==</code> <code class="s1">'avail'</code>
    <code class="n">users</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s1">','</code><code class="p">)</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">user</code><code class="o">|</code>
      <code class="n">access</code><code class="o">[</code><code class="n">user</code><code class="o">]</code> <code class="o">||=</code> <code class="o">[]</code>
      <code class="n">access</code><code class="o">[</code><code class="n">user</code><code class="o">]</code> <code class="o">&lt;&lt;</code> <code class="n">path</code>
    <code class="k">end</code>
  <code class="k">end</code>
  <code class="n">access</code>
<code class="k">end</code>
</pre>

<p>先ほどの ACL ファイルをこの <code>get_acl_access_data</code> メソッドに渡すと、このようなデータ構造を返します。</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="p">{</code><code class="s2">"defunkt"</code><code class="o">=&gt;[</code><code class="kp">nil</code><code class="o">]</code><code class="p">,</code>
 <code class="s2">"tpw"</code><code class="o">=&gt;[</code><code class="kp">nil</code><code class="o">]</code><code class="p">,</code>
 <code class="s2">"nickh"</code><code class="o">=&gt;[</code><code class="kp">nil</code><code class="o">]</code><code class="p">,</code>
 <code class="s2">"pjhyett"</code><code class="o">=&gt;[</code><code class="kp">nil</code><code class="o">]</code><code class="p">,</code>
 <code class="s2">"schacon"</code><code class="o">=&gt;[</code><code class="s2">"lib"</code><code class="p">,</code> <code class="s2">"tests"</code><code class="o">]</code><code class="p">,</code>
 <code class="s2">"cdickens"</code><code class="o">=&gt;[</code><code class="s2">"doc"</code><code class="o">]</code><code class="p">,</code>
 <code class="s2">"usinclair"</code><code class="o">=&gt;[</code><code class="s2">"doc"</code><code class="o">]</code><code class="p">,</code>
 <code class="s2">"ebronte"</code><code class="o">=&gt;[</code><code class="s2">"doc"</code><code class="o">]</code><code class="p">}</code>
</pre>

<p>これで権限がわかったので、あとはプッシュされた各コミットがどのパスを変更しようとしているのかを調べれば、そのユーザーがプッシュできるのか判断できます。</p>

<p>あるコミットでどのファイルが変更されるのかを知るのはとても簡単で、<code>git log</code> コマンドに <code>--name-only</code> オプションを指定するだけです（<a data-type="xref" href="1-git-basics/_viewing_history">コミット履歴の閲覧</a> で簡単に説明しました）。</p>

<pre data-type="programlisting" data-code-language="console"><code class="gp">$</code> git log -1 --name-only --pretty<code class="o">=</code>format:<code class="s1">''</code> 9f585d

<code class="go">README</code>
<code class="go">lib/test.rb</code>
</pre>

<p><code>get_acl_access_data</code> メソッドが返す ACL のデータとこのファイルリストを付き合わせれば、そのユーザーにコミットをプッシュする権限があるかどうかを判断できます。</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="c1"># only allows certain users to modify certain subdirectories in a project</code>
<code class="k">def</code> <code class="nf">check_directory_perms</code>
  <code class="n">access</code> <code class="o">=</code> <code class="n">get_acl_access_data</code><code class="p">(</code><code class="s1">'acl'</code><code class="p">)</code>

  <code class="c1"># see if anyone is trying to push something they can't</code>
  <code class="n">new_commits</code> <code class="o">=</code> <code class="sb">`git rev-list </code><code class="si">#{</code><code class="vg">$oldrev</code><code class="si">}</code><code class="sb">..</code><code class="si">#{</code><code class="vg">$newrev</code><code class="si">}</code><code class="sb">`</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code>
  <code class="n">new_commits</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">rev</code><code class="o">|</code>
    <code class="n">files_modified</code> <code class="o">=</code> <code class="sb">`git log -1 --name-only --pretty=format:'' </code><code class="si">#{</code><code class="n">rev</code><code class="si">}</code><code class="sb">`</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code>
    <code class="n">files_modified</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">path</code><code class="o">|</code>
      <code class="k">next</code> <code class="k">if</code> <code class="n">path</code><code class="o">.</code><code class="n">size</code> <code class="o">==</code> <code class="mi">0</code>
      <code class="n">has_file_access</code> <code class="o">=</code> <code class="kp">false</code>
      <code class="n">access</code><code class="o">[</code><code class="vg">$user</code><code class="o">].</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">access_path</code><code class="o">|</code>
        <code class="k">if</code> <code class="o">!</code><code class="n">access_path</code>  <code class="c1"># user has access to everything</code>
           <code class="o">||</code> <code class="p">(</code><code class="n">path</code><code class="o">.</code><code class="n">start_with?</code> <code class="n">access_path</code><code class="p">)</code> <code class="c1"># access to this path</code>
          <code class="n">has_file_access</code> <code class="o">=</code> <code class="kp">true</code>
        <code class="k">end</code>
      <code class="k">end</code>
      <code class="k">if</code> <code class="o">!</code><code class="n">has_file_access</code>
        <code class="nb">puts</code> <code class="s2">"[POLICY] You do not have access to push to </code><code class="si">#{</code><code class="n">path</code><code class="si">}</code><code class="s2">"</code>
        <code class="nb">exit</code> <code class="mi">1</code>
      <code class="k">end</code>
    <code class="k">end</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">check_directory_perms</code>
</pre>

<p>まず最初に <code>git rev-list</code> でサーバへプッシュされるコミットの一覧を取得します。
次に、それぞれのコミットでどのファイルが変更されるのかを調べ、プッシュしてきたユーザーにそのファイルを変更する権限があるか確かめています。</p>

<p>これで、まずい形式のコミットメッセージや、指定されたパス以外のファイルの変更を含むコミットはプッシュできなくなりました。</p>
</section><section data-type="sect3" id="-BETkuaiMHz"><h4>テストを実施する</h4>

<p>これまでのコードを書き込んだファイルに対して <code>chmod u+x .git/hooks/update</code> を実行します。その上で、メッセージが規定に沿っていないコミットをプッシュしてみましょう。すると、こんなメッセージが表示されるでしょう。</p>

<pre data-type="programlisting" data-code-language="console"><code class="gp">$</code> git push -f origin master
<code class="go">Counting objects: 5, done.</code>
<code class="go">Compressing objects: 100% (3/3), done.</code>
<code class="go">Writing objects: 100% (3/3), 323 bytes, done.</code>
<code class="go">Total 3 (delta 1), reused 0 (delta 0)</code>
<code class="go">Unpacking objects: 100% (3/3), done.</code>
<code class="go">Enforcing Policies...</code>
<code class="go">(refs/heads/master) (8338c5) (c5b616)</code>
<code class="go">[POLICY] Your message is not formatted correctly</code>
<code class="go">error: hooks/update exited with error code 1</code>
<code class="go">error: hook declined to update refs/heads/master</code>
<code class="go">To git@gitserver:project.git</code>
<code class="go"> ! [remote rejected] master -&gt; master (hook declined)</code>
<code class="go">error: failed to push some refs to 'git@gitserver:project.git'</code>
</pre>

<p>この中には、いくつか興味深い点があります。
まず、フックの実行が始まったときの次の表示に注目しましょう。</p>

<pre data-type="programlisting" data-code-language="console"><code class="go">Enforcing Policies...</code>
<code class="go">(refs/heads/master) (fb8c72) (c56860)</code>
</pre>

<p>これは、スクリプトの先頭で標準出力に表示した内容でした。
ここで重要なのは「スクリプトから <code>stdout</code> に送った内容は、すべてクライアントにも送られる」ということです。</p>

<p>次に注目するのは、エラーメッセージです。</p>

<pre data-type="programlisting" data-code-language="console"><code class="go">[POLICY] Your message is not formatted correctly</code>
<code class="go">error: hooks/update exited with error code 1</code>
<code class="go">error: hook declined to update refs/heads/master</code>
</pre>

<p>最初の行はスクリプトから出力したもので、その他の 2 行は Git が出力したものです。この 2 行では、スクリプトがゼロ以外の値で終了したためにプッシュが却下されたということを説明しています。
最後に、次の部分に注目します。</p>

<pre data-type="programlisting" data-code-language="console"><code class="go">To git@gitserver:project.git</code>
<code class="go"> ! [remote rejected] master -&gt; master (hook declined)</code>
<code class="go">error: failed to push some refs to 'git@gitserver:project.git'</code>
</pre>

<p>フックで却下したすべての参照について、remote rejected メッセージが表示されます。これを見れば、フック内での処理のせいで却下されたのだということがわかります。</p>

<p>また、変更権限のないファイルを変更してそれを含むコミットをプッシュしようとしたときも、同様にエラーが表示されます。
たとえば、ドキュメント担当者が <code>lib</code> ディレクトリ内の何かを変更しようとした場合のメッセージは次のようになります。</p>

<pre data-type="programlisting" data-code-language="console"><code class="go">[POLICY] You do not have access to push to lib/test.rb</code>
</pre>

<p>以降、この <code>update</code> スクリプトが動いてさえいれば、指定したパターンを含まないコミットメッセージがリポジトリに登録されることは二度とありません。また、ユーザーに変なところをさわられる心配もなくなります。</p>
</section></section><section data-type="sect2" id="-KpT6HVHz"><h3 id="クライアントサイドフック"><a href="#クライアントサイドフック">クライアントサイドフック</a></h3>

<p>この方式の弱点は、プッシュが却下されたときにユーザーが泣き寝入りせざるを得なくなるということです。
手間暇かけて仕上げた作業が最後の最後で却下されるというのは、非常にストレスがたまるし不可解です。さらに、プッシュするためには歴史を修正しなければならないのですが、気弱な人にとってそれはかなりつらいことです。</p>

<p>このジレンマに対する答えとして、サーバーが却下するであろう作業をするときに、それをユーザーに伝えるためのクライアントサイドフックを用意します。
そうすれば、何か問題があるときに、それをコミットする前に知ることができるので、取り返しのつかなくなる前に問題を修正することができます。
なおプロジェクトをクローンしてもフックはコピーされないので、別の何らかの方法で各ユーザーにスクリプトを配布した上で、各ユーザーにそれを <code>.git/hooks</code> にコピーさせ、実行可能にさせる必要があります。
フックスクリプト自体をプロジェクトに含めたり別のプロジェクトにしたりすることはできますが、各自の環境でそれをフックとして自動的に設定することはできません。</p>

<p>はじめに、コミットを書き込む直前にコミットメッセージをチェックしなければなりません。コミットメッセージの書式に問題があったがために、変更がサーバーに却下されるということがないように、コミットメッセージの書式を調べるのです。
これを行うには <code>commit-msg</code> フックを使います。
最初の引数で渡されたファイルからコミットメッセージを読み込んでパターンと比較し、もしマッチしなければ Git の処理を中断させます。</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="c1">#!/usr/bin/env ruby</code>
<code class="n">message_file</code> <code class="o">=</code> <code class="no">ARGV</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code>
<code class="n">message</code> <code class="o">=</code> <code class="no">File</code><code class="o">.</code><code class="n">read</code><code class="p">(</code><code class="n">message_file</code><code class="p">)</code>

<code class="vg">$regex</code> <code class="o">=</code> <code class="sr">/\[ref: (\d+)\]/</code>

<code class="k">if</code> <code class="o">!</code><code class="vg">$regex</code><code class="o">.</code><code class="n">match</code><code class="p">(</code><code class="n">message</code><code class="p">)</code>
  <code class="nb">puts</code> <code class="s2">"[POLICY] Your message is not formatted correctly"</code>
  <code class="nb">exit</code> <code class="mi">1</code>
<code class="k">end</code>
</pre>

<p>このスクリプトを適切な場所 (<code>.git/hooks/commit-msg</code>) に置いて実行可能にしておくと、不適切なメッセージを書いてコミットしようとしたときに次のような結果となります。</p>

<pre data-type="programlisting" data-code-language="console"><code class="gp">$</code> git commit -am <code class="s1">'test'</code>
<code class="go">[POLICY] Your message is not formatted correctly</code>
</pre>

<p>このとき、実際にはコミットされません。
もしメッセージが適切な書式になっていれば、Git はコミットを許可します。</p>

<pre data-type="programlisting" data-code-language="console"><code class="gp">$</code> git commit -am <code class="s1">'test [ref: 132]'</code>
<code class="go">[master e05c914] test [ref: 132]</code>
<code class="go"> 1 file changed, 1 insertions(+), 0 deletions(-)</code>
</pre>

<p>次に、ACL で決められた範囲以外のファイルを変更していないことを確認しましょう。
先ほど使った ACL ファイルのコピーがプロジェクトの <code>.git</code> ディレクトリにあれば、次のような <code>pre-commit</code> スクリプトでチェックすることができます。</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="c1">#!/usr/bin/env ruby</code>

<code class="vg">$user</code>    <code class="o">=</code> <code class="no">ENV</code><code class="o">[</code><code class="s1">'USER'</code><code class="o">]</code>

<code class="c1"># [ insert acl_access_data method from above ]</code>

<code class="c1"># only allows certain users to modify certain subdirectories in a project</code>
<code class="k">def</code> <code class="nf">check_directory_perms</code>
  <code class="n">access</code> <code class="o">=</code> <code class="n">get_acl_access_data</code><code class="p">(</code><code class="s1">'.git/acl'</code><code class="p">)</code>

  <code class="n">files_modified</code> <code class="o">=</code> <code class="sb">`git diff-index --cached --name-only HEAD`</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code>
  <code class="n">files_modified</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">path</code><code class="o">|</code>
    <code class="k">next</code> <code class="k">if</code> <code class="n">path</code><code class="o">.</code><code class="n">size</code> <code class="o">==</code> <code class="mi">0</code>
    <code class="n">has_file_access</code> <code class="o">=</code> <code class="kp">false</code>
    <code class="n">access</code><code class="o">[</code><code class="vg">$user</code><code class="o">].</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">access_path</code><code class="o">|</code>
    <code class="k">if</code> <code class="o">!</code><code class="n">access_path</code> <code class="o">||</code> <code class="p">(</code><code class="n">path</code><code class="o">.</code><code class="n">index</code><code class="p">(</code><code class="n">access_path</code><code class="p">)</code> <code class="o">==</code> <code class="mi">0</code><code class="p">)</code>
      <code class="n">has_file_access</code> <code class="o">=</code> <code class="kp">true</code>
    <code class="k">end</code>
    <code class="k">if</code> <code class="o">!</code><code class="n">has_file_access</code>
      <code class="nb">puts</code> <code class="s2">"[POLICY] You do not have access to push to </code><code class="si">#{</code><code class="n">path</code><code class="si">}</code><code class="s2">"</code>
      <code class="nb">exit</code> <code class="mi">1</code>
    <code class="k">end</code>
  <code class="k">end</code>
<code class="k">end</code>

<code class="n">check_directory_perms</code>
</pre>

<p>大まかにはサーバーサイドのスクリプトと同じですが、重要な違いがふたつあります。
まず、ACL ファイルの場所が違います。このスクリプトは作業ディレクトリから実行するものであり、<code>.git</code> ディレクトリから実行するものではないからです。
ACL ファイルの場所を、先ほどの</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="n">access</code> <code class="o">=</code> <code class="n">get_acl_access_data</code><code class="p">(</code><code class="s1">'acl'</code><code class="p">)</code>
</pre>

<p>から次のように変更しなければなりません。</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="n">access</code> <code class="o">=</code> <code class="n">get_acl_access_data</code><code class="p">(</code><code class="s1">'.git/acl'</code><code class="p">)</code>
</pre>

<p>もうひとつの違いは、変更されたファイルの一覧を取得する方法です。
サーバーサイドのメソッドではコミットログを調べていました。しかしこの時点ではまだコミットが記録されていないので、ファイルの一覧はステージング・エリアから取得しなければなりません。
つまり、先ほどの</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="n">files_modified</code> <code class="o">=</code> <code class="sb">`git log -1 --name-only --pretty=format:'' </code><code class="si">#{</code><code class="n">ref</code><code class="si">}</code><code class="sb">`</code>
</pre>

<p>は次のようになります。</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="n">files_modified</code> <code class="o">=</code> <code class="sb">`git diff-index --cached --name-only HEAD`</code>
</pre>

<p>しかし、違うのはこの二点だけで、それ以外はまったく同じように動作します。
ただしこのスクリプトは、ローカルで実行しているユーザーと、リモートマシンにプッシュするときのユーザーが同じであることを前提にしています。
もし異なる場合は、変数 <code>$user</code> を手動で設定しなければなりません。</p>

<p>最後に残ったのは fast-forward でないプッシュを止めることです。
fast-forward でない参照を取得するには、すでにプッシュした過去のコミットにリベースするか、別のローカルブランチにリモートブランチと同じところまでプッシュしなければなりません。</p>

<p>サーバーサイドではすでに <code>receive.denyDeletes</code> と <code>receive.denyNonFastForwards</code> でこのポリシーを強制しているでしょうから、あり得るのは、すでにプッシュ済みのコミットをリベースしようとするときくらいです。</p>

<p>それをチェックする pre-rebase スクリプトの例を示します。
これは書き換えようとしているコミットの一覧を取得し、それがリモート参照の中に存在するかどうかを調べます。
リモート参照から到達可能なコミットがひとつでもあれば、リベースを中断します。</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="c1">#!/usr/bin/env ruby</code>

<code class="n">base_branch</code> <code class="o">=</code> <code class="no">ARGV</code><code class="o">[</code><code class="mi">0</code><code class="o">]</code>
<code class="k">if</code> <code class="no">ARGV</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code>
  <code class="n">topic_branch</code> <code class="o">=</code> <code class="no">ARGV</code><code class="o">[</code><code class="mi">1</code><code class="o">]</code>
<code class="k">else</code>
  <code class="n">topic_branch</code> <code class="o">=</code> <code class="s2">"HEAD"</code>
<code class="k">end</code>

<code class="n">target_shas</code> <code class="o">=</code> <code class="sb">`git rev-list </code><code class="si">#{</code><code class="n">base_branch</code><code class="si">}</code><code class="sb">..</code><code class="si">#{</code><code class="n">topic_branch</code><code class="si">}</code><code class="sb">`</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code>
<code class="n">remote_refs</code> <code class="o">=</code> <code class="sb">`git branch -r`</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code><code class="o">.</code><code class="n">map</code> <code class="p">{</code> <code class="o">|</code><code class="n">r</code><code class="o">|</code> <code class="n">r</code><code class="o">.</code><code class="n">strip</code> <code class="p">}</code>

<code class="n">target_shas</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">sha</code><code class="o">|</code>
  <code class="n">remote_refs</code><code class="o">.</code><code class="n">each</code> <code class="k">do</code> <code class="o">|</code><code class="n">remote_ref</code><code class="o">|</code>
    <code class="n">shas_pushed</code> <code class="o">=</code> <code class="sb">`git rev-list ^</code><code class="si">#{</code><code class="n">sha</code><code class="si">}</code><code class="sb">^@ refs/remotes/</code><code class="si">#{</code><code class="n">remote_ref</code><code class="si">}</code><code class="sb">`</code>
    <code class="k">if</code> <code class="n">shas_pushed</code><code class="o">.</code><code class="n">split</code><code class="p">(</code><code class="s2">"</code><code class="se">\n</code><code class="s2">"</code><code class="p">)</code><code class="o">.</code><code class="n">include?</code><code class="p">(</code><code class="n">sha</code><code class="p">)</code>
      <code class="nb">puts</code> <code class="s2">"[POLICY] Commit </code><code class="si">#{</code><code class="n">sha</code><code class="si">}</code><code class="s2"> has already been pushed to </code><code class="si">#{</code><code class="n">remote_ref</code><code class="si">}</code><code class="s2">"</code>
      <code class="nb">exit</code> <code class="mi">1</code>
    <code class="k">end</code>
  <code class="k">end</code>
<code class="k">end</code>
</pre>

<p>このスクリプトでは、 <a data-type="xref" href="1-git-tools/_revision_selection.html">リビジョンの選択</a> ではカバーしていない構文を使っています。
既にプッシュ済みのコミットの一覧を得るために、次のコマンドを実行します。</p>

<pre data-type="programlisting" data-code-language="ruby"><code class="sb">`git rev-list ^</code><code class="si">#{</code><code class="n">sha</code><code class="si">}</code><code class="sb">^@ refs/remotes/</code><code class="si">#{</code><code class="n">remote_ref</code><code class="si">}</code><code class="sb">`</code>
</pre>

<p><code>SHA^@</code> 構文は、そのコミットのすべての親を解決します。
リモートの最後のコミットから到達可能で、これからプッシュしようとする SHA-1 の親のいずれかからもアクセスできないコミット（これによって fast-forward であることが分かります）を探します。</p>

<p>この方式の弱点は非常に時間がかかることで、多くの場合このチェックは不要です。<code>-f</code> つきで強制的にプッシュしようとしない限り、サーバーが警告を出してプッシュできないからです。
しかし練習用の課題としてはおもしろいもので、あとでリベースを取り消してやりなおすはめになることを理屈上は防げるようになります。</p>
</section><div id="nav"><a href="../Git-%e3%81%ae%e3%82%ab%e3%82%b9%e3%82%bf%e3%83%9e%e3%82%a4%e3%82%ba-Git-%e3%83%95%e3%83%83%e3%82%af">prev</a> | <a href="Git-%e3%81%ae%e3%82%ab%e3%82%b9%e3%82%bf%e3%83%9e%e3%82%a4%e3%82%ba-%e3%81%be%e3%81%a8%e3%82%81.html">next</a></div></div>
</div>

        </div>
      </div>
      <footer>
  <div class="site-source">
    This <a href="https://github.com/git/git-scm.com/blob/master/README.md#license">open sourced</a> site is <a href="https://github.com/git/git-scm.com">hosted on GitHub.</a><br>
    Patches, suggestions and comments are welcome.
  </div>
  <div class="sfc-member">
    Git is a member of <a href="http://git-scm.com/sfc">Software Freedom Conservancy</a>
  </div>
</footer>







    </div>

</body>
</html>
